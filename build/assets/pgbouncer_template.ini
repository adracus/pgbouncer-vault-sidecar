[databases]
# FIXME: We need to refer to a certain role here - this is pending our implementation of a role concept
# ROLE requested: {{ env "DB_ROLE" }}

{{ $namespace := env "POD_NAMESPACE" }}
{{ $dbname := env "DB_NAME" }}
{{ $dbhost := env "DB_HOST" | replaceAll "$POD_NAME" $namespace |  replaceAll "$DB_NAME" $dbname }}
{{ $dbport := or (env "DB_PORT") "5432" }}
{{ $vaultpath := env "VAULT_PATH" | replaceAll "$POD_NAME" $namespace |  replaceAll "$DB_NAME" $dbname }}
{{ $sslmode := or (env "SSL_MODE") "require" }}
{{ $listenport := or (env "LISTEN_PORT") "5432" }}

# TODO support multiple databases

{{ with secret $vaultpath }}
{{ $dbname }} = host={{ $dbhost }} port={{ $dbport }} dbname={{ $dbname }} user={{ .Data.username  }} password={{ .Data.password  }}
{{ end }}

[pgbouncer]
listen_addr = 127.0.0.1
listen_port = {{ $listenport }}
auth_type = any
admin_users = app_admin, app_admin2
pool_mode = transaction
max_client_conn = 100
default_pool_size = 20
# Fixme: `require` enforces tls, but doesn't verify server certificate. Due it's currently not shared by postgres operator.
server_tls_sslmode = {{ $sslmode }}
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/log/pgbouncer/pgbouncer.pid
# some Java libraries set this extra_float_digits implicitly: https://github.com/Athou/commafeed/issues/559
ignore_startup_parameters = extra_float_digits
